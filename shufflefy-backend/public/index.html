<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">

    <title>Shufflefy</title>
</head>

<body>
    <h1>Your Playlists</h1>
    <div id="playlists"></div>
    <iframe id ="spotifyEmbed"
            style="border-radius:12px"
            src="https://open.spotify.com/embed/track/18yAbyPSVNOypgT1iM7GU6?utm_source=generator" 
            width="100%" 
            height="352" 
            frameBorder="0" 
            allowfullscreen="" 
            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
            loading="lazy"></iframe>

    
    <script src="https://unpkg.com/node-vibrant@3.1.6/dist/vibrant.min.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>

    <div class="player-container" id="playerContainer">
        <img class="album-art" id="albumArt" src="https://via.placeholder.com/300" alt="Album Art">
        <div class="track-info">
          <div class="track-title" id="trackTitle">Track Title</div>
          <div class="artist-name" id="artistName">Artist Name</div>
        </div>
        <div class="controls">
          <button onclick="previousTrack()">&#9664;&#9664;</button>
          <button onclick="togglePlayPause()">&#9654;</button>
          <button onclick="nextTrack()">&#9654;&#9654;</button>
        </div>
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>


            
    <script>
    function checkAuth() {
        const accessToken = new URLSearchParams(window.location.search).get('accessToken');

        //If user is not logged in, redirect to login
        if (!accessToken) {
            window.location.href = "http://localhost:5000/login";
        } else {
            fetchPlaylists();
        }
    }
        
    window.onload = checkAuth;

    let player = null;
    let playerReady = false;
    let deviceId = null;
    let playlistId = null;
    let currentTrackUri = null;

    window.onSpotifyWebPlaybackSDKReady = async () => {
        const accessToken = new URLSearchParams(window.location.search).get('accessToken');
        if (accessToken){
            player = new Spotify.Player({
                name: 'Shufflefy',
                getOAuthToken: cb => { cb(accessToken); },
                volume: 0.5
            });

                    
            // Ready
            player.addListener('ready', ({ device_id }) => {
                deviceId = device_id;
                playerReady = true;
                startProgressUpdates()
            });

            // Not Ready
            player.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID has gone offline', device_id);
                playerReady = false;
                stopProgressUpdates();
            });

            player.addListener('initialization_error', ({ message }) => {
                console.error(message);
            });

            player.addListener('authentication_error', ({ message }) => {
                console.error(message);
            });

            player.addListener('account_error', ({ message }) => {
                console.error(message);
            });

            player.addListener('player_state_changed', async state =>  {
                if (state) {
                    updateUI(state);

                    if (currentTrackUri != state.track_window.current_track.uri){
                        currentTrackUri = state.track_window.current_track.uri
                        const newTrackUri = await getRandomSong(playlistId);
                        addToQueue(newTrackUri);
                    }
                }
            });

            player.connect();
        }
    }

    function darkenColor(color, factor) {
        const hex = color.slice(1);
        const r = parseInt(hex.slice(0, 2), 16);
        const g = parseInt(hex.slice(2, 4), 16);
        const b = parseInt(hex.slice(4, 6), 16);
        const rgb = [r, g, b];
        const darkenedColor = rgb.map(channel => Math.max(0, channel - factor));
        return `rgb(${darkenedColor.join(',')})`;
    }

    function updateUI(state){
        updatePlayerVisibility(state); 
        const playerContainer = document.getElementById('playerContainer');
        const albumArt = document.getElementById('albumArt');

        const currentTrack = state.track_window.current_track;
        document.getElementById('trackTitle').textContent = currentTrack.name;
        document.getElementById('artistName').textContent = currentTrack.artists.map(artist => artist.name).join(', ');
        albumArt.src = currentTrack.album.images[0].url;

        Vibrant.from(albumArt.src).getPalette().then((palette) => {
            const dominantColor = palette.Vibrant.getHex(); // Get dominant color
            const darkenedColor = darkenColor(dominantColor, 50);
            playerContainer.style.backgroundColor = darkenedColor; // Update player background color
        });

        // Update progress bar (example calculation)
        let progress = (state.position / state.duration) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
    }

    document.getElementById('progressContainer').addEventListener('click', (event) => {
        const rect = progressContainer.getBoundingClientRect();
        const offsetX = event.clientX - rect.left; // Click position relative to the container
        const totalWidth = rect.width;
        const clickPercent = offsetX / totalWidth;

        player.getCurrentState().then(state => {
            let duration = state.duration;
            const newTime = clickPercent * duration;
            player.seek(newTime);
        });
    });

    let updateProgressInterval;

    function updateProgress() {
        if (player) {
            player.getCurrentState().then(state => {
                if (state && !state.paused) {
                    let progress = (state.position / state.duration) * 100;
                    document.getElementById('progressBar').style.width = progress + '%'; // Update the progress bar
                }
            });
        }
    }
    
    function startProgressUpdates() {
        if (!updateProgressInterval) {
            updateProgressInterval = setInterval(updateProgress, 100); // Update every 100ms
        }
    }

    function stopProgressUpdates() {
        clearInterval(updateProgressInterval);
        updateProgressInterval = null;
    }   

    //Hide player until a track is loaded
    function updatePlayerVisibility(state) {
      const playerContainer = document.getElementById('playerContainer');
      if (player && deviceId && state.track_window.current_track) {
        playerContainer.classList.add('player-visible');
        playerContainer.classList.remove('player-hidden');
      } else {
        playerContainer.classList.add('player-hidden');
        playerContainer.classList.remove('player-visible');
      }
    }

    function togglePlayPause(){
        if (playerReady){
            player.togglePlay();
        }
    };

    function previousTrack(){
        if (playerReady){
            player.previousTrack();
        }
    };

    function nextTrack(){
        if (playerReady){
            player.nextTrack();
        }
    }

    // Assuming you already have the access token stored in accessToken variable
    const accessToken = new URLSearchParams(window.location.search).get('accessToken');

    async function fetchPlaylists() {
        const response = await fetch('http://localhost:5000/playlists', {
            headers: {
                Authorization: `Bearer ${accessToken}`,
            },
        });

        const data = await response.json();
        displayPlaylists(data);
    }

    function displayPlaylists(playlists) {
        const playlistsContainer = document.getElementById('playlists');
        playlistsContainer.innerHTML = ''; // Clear previous content

        playlists.forEach((playlist) => {
            const playlistDiv = document.createElement('div');
            playlistDiv.textContent = playlist.name;
            playlistDiv.style.cursor = 'pointer';
            playlistDiv.onclick = () => playlistChosen(playlist.id);
            playlistsContainer.appendChild(playlistDiv);
        });
    }

    async function playlistChosen(playlist_id){
        playlistId = playlist_id;
        currentTrackUri = await getRandomSong(playlistId);
        await playTrack(currentTrackUri);
        addToQueue(await getRandomSong(playlistId));
        addToQueue(await getRandomSong(playlistId));
        addToQueue(await getRandomSong(playlistId));
    }

    async function getRandomSong(playlistId) {
        const response = await fetch(`http://localhost:5000/playlists/${playlistId}/tracks`, {
            headers: {
                Authorization: `Bearer ${accessToken}`,
            },
        });

        const data = await response.json();

        const randomTrack = data[Math.floor(Math.random() * data.length)];
        const trackUri = randomTrack.track.uri;
        const trackEmbedUri = `https://open.spotify.com/embed/track/${trackUri.split(':')[2]}`;

        const spotifyEmbed = document.getElementById('spotifyEmbed');
        spotifyEmbed.src = trackEmbedUri;

        return trackUri;
    }

    async function playTrack(trackUri) {
        if (playerReady){
            const response = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    uris: [trackUri],
                }),
            });

            if (response.ok) {
                console.log('Playback started successfully');
            } else {
                console.error('Failed to start playback:', response.statusText);
            }
        } else {
            console.error("Player not ready");
        }
    }

    async function addToQueue(trackUri) {
        try {
            const response = await fetch(`https://api.spotify.com/v1/me/player/queue?uri=${trackUri}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json',
                },
            });

            if (!response.ok) {
                throw new Error(`Error adding to queue: ${response.statusText}`);
            }

            console.log(`Track added to queue: ${trackUri}`);
        } catch (error) {
            console.error('Error:', error);
        }
    }

    fetchPlaylists();
    </script>
</body>

</html>
